import { useEffect, useState } from 'react';
import { writeTextFile } from '@tauri-apps/plugin-fs';
import { downloadDir, join } from '@tauri-apps/api/path';

import { FontAwesomeIcon } from '@fortawesome/react-fontawesome';
import {
  faRotateLeft,
  faCopy,
  faDownload,
  faCheck,
  faRocket,
  faCog,
  faLightbulb,
  faArrowLeft,
  faTableList,
  faCalendarDays,
  faWandMagicSparkles,
  faArrowRight,
  faCompress,
  faCode,
  faPaperPlane,
} from '@fortawesome/free-solid-svg-icons';
import { ZenSubtitle } from '../../kits/PatternKit/ZenSubtitle';
import { ZenRoughButton, ZenPlannerModal, ZenPostenModal, ZenPostMethodModal } from '../../kits/PatternKit/ZenModalSystem';
import { ZenMarkdownPreview } from '../../kits/PatternKit/ZenMarkdownPreview';
import {
  ContentPlatform,
  improveText,
  continueText,
  summarizeText,
  textToMarkdown,
} from '../../services/aiService';
import type { ScheduledPost } from '../../types/scheduling';
import {
  postToSocialMedia,
  loadSocialConfig,
  isPlatformConfigured,
  SocialPlatform,
  PostResult,
} from '../../services/socialMediaService';

interface Step4TransformResultProps {
  transformedContent: string;
  platform: ContentPlatform;
  autoSelectedModel?: string | null;
  onReset: () => void;
  onBack: () => void;
  onOpenSettings: () => void;
  onContentChange?: (content: string) => void; // Allow updating content after translation
  cameFromDocStudio?: boolean;
  cameFromDashboard?: boolean;
  isPreview?: boolean;
  headerAction?: "copy" | "download" | "edit" | "post" | "posten" | "reset" | "back_doc" | "back_dashboard" | null;
  onHeaderActionHandled?: () => void;
  useHeaderActions?: boolean;
  onBackToDocStudio?: (editedContent?: string) => void;
  onBackToDashboard?: (generatedContent?: string) => void;
  onGoToTransform?: (platform: ContentPlatform) => void; // Navigate to Step 2/3 for AI transformation
  // Multi-platform mode props
  multiPlatformMode?: boolean;
  transformedContents?: Partial<Record<ContentPlatform, string>>;
  activeResultTab?: ContentPlatform | null;
  onActiveResultTabChange?: (platform: ContentPlatform) => void;
}



const platformLabels: Record<ContentPlatform, string> = {
  linkedin: 'LinkedIn Post',
  devto: 'dev.to Artikel',
  twitter: 'Twitter Thread',
  medium: 'Medium Blog',
  reddit: 'Reddit Post',
  'github-discussion': 'GitHub Discussion',
  'github-blog': 'GitHub Blog Post',
  youtube: 'YouTube Description',
  'blog-post': 'Blog Post',
};

// Map ContentPlatform to SocialPlatform
const platformMapping: Record<ContentPlatform, SocialPlatform | null> = {
  twitter: 'twitter',
  reddit: 'reddit',
  linkedin: 'linkedin',
  devto: 'devto',
  medium: 'medium',
  'github-discussion': 'github',
  'github-blog': 'github',
  youtube: null, // YouTube doesn't have direct posting API in this implementation
  'blog-post': null, // Generic blog post doesn't have direct posting
};

export const Step4TransformResult = ({
  transformedContent,
  platform,
  autoSelectedModel,
  onReset,
  onBack,
  onOpenSettings,
  onContentChange,
  cameFromDocStudio,
  cameFromDashboard,
  isPreview = false,
  headerAction,
  onHeaderActionHandled,
  useHeaderActions = false,
  onBackToDocStudio,
  onBackToDashboard,
  onGoToTransform,
  multiPlatformMode = false,
  transformedContents = {},
  activeResultTab,
  onActiveResultTabChange,
}: Step4TransformResultProps) => {
  const [copied, setCopied] = useState(false);
  const [isPosting, setIsPosting] = useState(false);
  const [postResult, setPostResult] = useState<PostResult | null>(null);
  const [currentContent, setCurrentContent] = useState(transformedContent);
  const [showPlannerModal, setShowPlannerModal] = useState(false);
  const [scheduledPosts, setScheduledPosts] = useState<ScheduledPost[]>([]);

  // Posten Modal State
  const [showPostenModal, setShowPostenModal] = useState(false);
  const [showPostMethodModal, setShowPostMethodModal] = useState(false);
  const [selectedPostPlatforms, setSelectedPostPlatforms] = useState<SocialPlatform[]>([]);
  const [isMultiPosting, setIsMultiPosting] = useState(false);
  const [multiPostResults, setMultiPostResults] = useState<PostResult[]>([]);

  // Text-AI State
  const [showTextAI, setShowTextAI] = useState(false);
  const [isAIProcessing, setIsAIProcessing] = useState(false);
  const [aiError, setAiError] = useState<string | null>(null);

  useEffect(() => {
    setCurrentContent(transformedContent);
  }, [transformedContent, platform, activeResultTab]);

  // Text-AI Handler
  const handleTextAI = async (action: 'improve' | 'continue' | 'summarize' | 'markdown') => {
    setIsAIProcessing(true);
    setAiError(null);

    try {
      let result;
      switch (action) {
        case 'improve':
          result = await improveText(currentContent);
          break;
        case 'continue':
          result = await continueText(currentContent);
          break;
        case 'summarize':
          result = await summarizeText(currentContent);
          break;
        case 'markdown':
          result = await textToMarkdown(currentContent);
          break;
      }

      if (result.success && result.data) {
        setCurrentContent(result.data);
        onContentChange?.(result.data);
        setShowTextAI(false);
      } else {
        setAiError(result.error || 'AI-Verarbeitung fehlgeschlagen');
      }
    } catch (error) {
      setAiError(error instanceof Error ? error.message : 'Unbekannter Fehler');
    } finally {
      setIsAIProcessing(false);
    }
  };

 
 
  const socialPlatform = platformMapping[platform];
  const config = loadSocialConfig();
  const hasConfig = socialPlatform ? isPlatformConfigured(socialPlatform, config) : false;

  const handleCopy = async () => {
    try {
      await navigator.clipboard.writeText(currentContent);
      setCopied(true);
      setTimeout(() => setCopied(false), 2000);
    } catch (err) {
      console.error('Failed to copy:', err);
    }
  };

  const handleContentUpdate = (newContent: string) => {
    setCurrentContent(newContent);
    onContentChange?.(newContent);
  };

const handleDownload = async () => {
  try {
    const filename = `${platform}-content.md`;
    const dir = await downloadDir();
    const path = await join(dir, filename);

    await writeTextFile(path, currentContent);

    alert(`Datei gespeichert:\n${path}`);
  } catch (error) {
    console.error("Error saving file:", error);
    alert("Fehler beim Speichern der Datei");
  }
};
  const handlePost = async () => {
    if (!socialPlatform) {
      alert('Diese Plattform unterstützt derzeit kein direktes Posten. Bitte kopiere den Content manuell.');
      return;
    }

    if (!hasConfig) {
      const shouldConfigure = window.confirm(
        'Du hast noch keine API-Credentials konfiguriert. Möchtest du das jetzt tun?\n\n' +
        'Hinweis: Die API-Integration ist optional. Du kannst den Content auch manuell kopieren und posten.'
      );
      if (shouldConfigure) {
        onOpenSettings();
      }
      return;
    }

    setIsPosting(true);
    setPostResult(null);

    try {
      // Prepare content based on platform
      let postContent: any;

      switch (platform) {
        case 'twitter':
          // Split into tweets if content is long
          const tweets = currentContent.split('\n\n').filter((t) => t.trim());
          postContent = {
            text: tweets[0],
            thread: tweets.length > 1 ? tweets.slice(1) : undefined,
          };
          break;

        case 'reddit':
          // Extract title from first line
          const lines = currentContent.split('\n');
          const title = lines[0].replace(/^#\s*/, '').substring(0, 300);
          const text = lines.slice(1).join('\n').trim();
          postContent = {
            subreddit: 'test', // User should specify this
            title,
            text,
          };
          break;

        case 'linkedin':
          postContent = {
            text: currentContent,
            visibility: 'PUBLIC',
          };
          break;

        case 'devto':
          const devtoLines = currentContent.split('\n');
          const devtoTitle = devtoLines[0].replace(/^#\s*/, '');
          const bodyMarkdown = devtoLines.slice(1).join('\n').trim();
          postContent = {
            title: devtoTitle,
            body_markdown: bodyMarkdown,
            published: false, // Draft by default
            tags: [],
          };
          break;

        case 'medium':
          const mediumLines = currentContent.split('\n');
          const mediumTitle = mediumLines[0].replace(/^#\s*/, '');
          const content = mediumLines.slice(1).join('\n').trim();
          postContent = {
            title: mediumTitle,
            content,
            contentFormat: 'markdown' as const,
            publishStatus: 'draft' as const,
          };
          break;

        case 'github-discussion':
          const ghLines = currentContent.split('\n');
          const ghTitle = ghLines[0].replace(/^#\s*/, '');
          const body = ghLines.slice(1).join('\n').trim();
          postContent = {
            owner: '', // User needs to specify
            repo: '', // User needs to specify
            title: ghTitle,
            body,
            categoryId: '', // User needs to specify
          };
          break;

        default:
          postContent = { text: currentContent };
      }

      const result = await postToSocialMedia(socialPlatform, postContent, config);
      setPostResult(result);

      if (result.success && result.url) {
        // Open the post in a new tab
        window.open(result.url, '_blank');
      }
    } catch (error) {
      setPostResult({
        success: false,
        platform: socialPlatform,
        error: error instanceof Error ? error.message : 'Unbekannter Fehler',
      });
    } finally {
      setIsPosting(false);
    }
  };

  // Multi-Platform Posting Handlers
  const handlePlatformSelection = (platforms: SocialPlatform[]) => {
    setSelectedPostPlatforms(platforms);
    setShowPostenModal(false);
    setShowPostMethodModal(true);
  };

  const prepareContentForPlatform = (targetPlatform: SocialPlatform): any => {
    const lines = currentContent.split('\n');
    const title = lines[0].replace(/^#\s*/, '');
    const body = lines.slice(1).join('\n').trim();

    switch (targetPlatform) {
      case 'twitter':
        const tweets = currentContent.split('\n\n').filter((t) => t.trim());
        return {
          text: tweets[0],
          thread: tweets.length > 1 ? tweets.slice(1) : undefined,
        };
      case 'reddit':
        return {
          subreddit: 'test',
          title: title.substring(0, 300),
          text: body,
        };
      case 'linkedin':
        return {
          text: currentContent,
          visibility: 'PUBLIC',
        };
      case 'devto':
        return {
          title,
          body_markdown: body,
          published: false,
          tags: [],
        };
      case 'medium':
        return {
          title,
          content: body,
          contentFormat: 'markdown' as const,
          publishStatus: 'draft' as const,
        };
      case 'github':
        return {
          owner: '',
          repo: '',
          title,
          body,
          categoryId: '',
        };
      default:
        return { text: currentContent };
    }
  };

  const handleMultiDirectPost = async () => {
    setShowPostMethodModal(false);
    setIsMultiPosting(true);
    setMultiPostResults([]);

    const results: PostResult[] = [];
    const currentConfig = loadSocialConfig();

    for (const targetPlatform of selectedPostPlatforms) {
      if (!isPlatformConfigured(targetPlatform, currentConfig)) {
        results.push({
          success: false,
          platform: targetPlatform,
          error: `${targetPlatform} nicht konfiguriert`,
        });
        continue;
      }

      try {
        const postContent = prepareContentForPlatform(targetPlatform);
        const result = await postToSocialMedia(targetPlatform, postContent, currentConfig);
        results.push(result);

        if (result.success && result.url) {
          window.open(result.url, '_blank');
        }
      } catch (error) {
        results.push({
          success: false,
          platform: targetPlatform,
          error: error instanceof Error ? error.message : 'Unbekannter Fehler',
        });
      }
    }

    setMultiPostResults(results);
    setIsMultiPosting(false);
  };

  const handleMultiAIOptimize = () => {
    setShowPostMethodModal(false);

    // Navigate to Step 2/3 for AI transformation
    // Use the first selected platform for transformation
    if (selectedPostPlatforms.length > 0 && onGoToTransform) {
      // Map SocialPlatform to ContentPlatform
      const socialToContent: Record<SocialPlatform, ContentPlatform> = {
        linkedin: 'linkedin',
        twitter: 'twitter',
        reddit: 'reddit',
        devto: 'devto',
        medium: 'medium',
        github: 'github-discussion',
      };
      const contentPlatform = socialToContent[selectedPostPlatforms[0]];
      onGoToTransform(contentPlatform);
    }
  };

  useEffect(() => {
    if (!headerAction) return;
    if (headerAction === "copy") {
      handleCopy();
    } else if (headerAction === "download") {
      handleDownload();
    } else if (headerAction === "edit") {
      onBack();
    } else if (headerAction === "post") {
      handlePost();
    } else if (headerAction === "posten") {
      setShowPostenModal(true);
    } else if (headerAction === "reset") {
      onReset();
    } else if (headerAction === "back_doc" && onBackToDocStudio) {
      onBackToDocStudio(currentContent);
    } else if (headerAction === "back_dashboard" && onBackToDashboard) {
      onBackToDashboard(currentContent);
    }
    onHeaderActionHandled?.();
  }, [
    headerAction,
    onHeaderActionHandled,
    onBack,
    onReset,
    onBackToDocStudio,
    onBackToDashboard,
    currentContent,
    handleCopy,
    handleDownload,
    handlePost,
  ]);

  return (
    <div className="flex-1 flex flex-col items-center justify-center px-6 py-12"
        style={{ padding: '0.5rem 1.5rem' }}
    
    >



      <div className="flex flex-col items-center w-full max-w-4xl">
        {/* Title */}
        <div className="mb-4">
          <h2 className="font-mono text-3xl text-[#dbd9d5] text-center">
            {isPreview ? "Dein Posting Vorschau " : "Transformation abgeschlossen :)"}
          </h2>
        </div>

        {/* Subtitle */}
        <div className="mb-12 text-center">
          <ZenSubtitle>
         {isPreview ? (
  <>
    Du siehst hier, wie dein Artikel aussieht.
    <br />
    Für Optimierung kannst du TEXT-AI nutzen oder auf Nachbearbeiten gehen und deine Plattform wählen.
  </>
) : multiPlatformMode && Object.keys(transformedContents).length > 1 ? (
  `Dein Content wurde für ${Object.keys(transformedContents).length} Plattformen optimiert`
) : (
  `Dein Content wurde für ${platformLabels[platform]} optimiert`
)}

          </ZenSubtitle>
        </div>

        {/* Multi-Platform Tab Bar */}
        {multiPlatformMode && Object.keys(transformedContents).length > 1 && (
          <div className="mb-8 w-full max-w-2xl">
            <div
              style={{
                display: 'flex',
                gap: '8px',
                padding: '8px',
                backgroundColor: '#1F1F1F',
                borderRadius: '12px',
                border: '1px solid #3A3A3A',
              }}
            >
              {Object.keys(transformedContents).map((platformKey) => {
                const platformValue = platformKey as ContentPlatform;
                const isActive = activeResultTab === platformValue;
                return (
                  <button
                    key={platformKey}
                    onClick={() => {
                      onActiveResultTabChange?.(platformValue);
                    }}
                    style={{
                      flex: 1,
                      padding: '10px 16px',
                      backgroundColor: isActive ? '#AC8E66' : 'transparent',
                      border: isActive ? 'none' : '1px solid #3A3A3A',
                      borderRadius: '8px',
                      cursor: 'pointer',
                      fontFamily: 'IBM Plex Mono, monospace',
                      fontSize: '12px',
                      fontWeight: isActive ? '600' : '400',
                      color: isActive ? '#1A1A1A' : '#999',
                      transition: 'all 0.2s',
                    }}
                    onMouseEnter={(e) => {
                      if (!isActive) {
                        e.currentTarget.style.backgroundColor = '#2A2A2A';
                        e.currentTarget.style.color = '#e5e5e5';
                      }
                    }}
                    onMouseLeave={(e) => {
                      if (!isActive) {
                        e.currentTarget.style.backgroundColor = 'transparent';
                        e.currentTarget.style.color = '#999';
                      }
                    }}
                  >
                    {platformLabels[platformValue]}
                  </button>
                );
              })}
            </div>
          </div>
        )}

        {/* Auto-Select Info */}
        {autoSelectedModel && (
          <div className="mb-8 w-full max-w-2xl">
            <div
              style={{
                display: 'flex',
                alignItems: 'center',
                gap: '12px',
                padding: '12px 20px',
                backgroundColor: '#2A2A2A',
                border: '1px solid #AC8E66',
                borderRadius: '8px',
              }}
            >
              <span style={{ fontSize: '18px' }}>✨</span>
              <div style={{ flex: 1 }}>
                <p
                  style={{
                    margin: 0,
                    fontSize: '11px',
                    fontFamily: 'monospace',
                    color: '#AC8E66',
                    fontWeight: 600,
                  }}
                >
                  Auto-Select aktiv
                </p>
                <p
                  style={{
                    margin: 0,
                    fontSize: '10px',
                    fontFamily: 'monospace',
                    color: '#999',
                    marginTop: '4px',
                  }}
                >
                  {autoSelectedModel}
                </p>
              </div>
            </div>
          </div>
        )}

        {/* Result Container */}
        <div className="w-full bg-[#2A2A2A] border border-[#AC8E66] "
          style={{
    width: "100%",
    backgroundColor: "#2A2A2A",
    border: "1px solid #AC8E66",
    borderRadius: "1.5rem",
            padding: '0.5rem 0',
  }}
        >
          <div className="flex justify-between items-center mb-4"
              style={{ padding: '0.5rem 1.5rem' }}
          >
            <h3 className="font-mono text-sm text-[#AC8E66]">Vorschau - Transformierter Content:</h3>
            <div className="flex items-center gap-3 px-[-10px]">
              {/* Text-AI Toggle Button */}
              <div className='px-[10px]'>
              <button
                onClick={() => setShowTextAI(!showTextAI)}
                className={`font-mono text-[10px] px-[10px] py-[10px] paddingLeft-[10px] rounded-lg border transition-all ${
                  showTextAI
                    ? 'bg-[#AC8E66] text-[#1A1A1A] border-[#AC8E66]'
                    : 'bg-transparent text-[#AC8E66] border-[#AC8E66] hover:bg-[#AC8E66]/10'
                }`}
                disabled={isAIProcessing}
              >
                <FontAwesomeIcon icon={faWandMagicSparkles} className="mr-2" />
                Text-AI
              </button>
              </div>
              <div className="font-mono text-[12px] text-[#AC8E66] px-3 py-1 rounded">
                Preview-Modus
              </div>
            </div>
          </div>

          {/* Text-AI Tab Bar */}
          {showTextAI && (
            <div style={{ padding: '0 1.5rem 1rem 1.5rem' }}>
              <div
                style={{
                  display: 'flex',
                  gap: '8px',
                  padding: '12px',
                  backgroundColor: '#1A1A1A',
                  borderRadius: '12px',
                  border: '1px solid #3a3a3a',
                  flexWrap: 'wrap',
                }}
              >
                {/* Text verbessern */}
                <button
                  onClick={() => handleTextAI('improve')}
                  disabled={isAIProcessing}
                  style={{
                    flex: '1 1 auto',
                    minWidth: '140px',
                    padding: '12px 16px',
                    backgroundColor: '#2A2A2A',
                    border: '1px solid #3a3a3a',
                    borderRadius: '8px',
                    color: '#e5e5e5',
                    fontFamily: 'monospace',
                    fontSize: '10px',
                    cursor: isAIProcessing ? 'not-allowed' : 'pointer',
                    opacity: isAIProcessing ? 0.5 : 1,
                    transition: 'all 0.2s',
                    display: 'flex',
                    flexDirection: 'column',
                    alignItems: 'center',
                    gap: '6px',
                  }}
                  onMouseEnter={(e) => {
                    if (!isAIProcessing) {
                      e.currentTarget.style.backgroundColor = '#3a3a3a';
                      e.currentTarget.style.borderColor = '#AC8E66';
                    }
                  }}
                  onMouseLeave={(e) => {
                    e.currentTarget.style.backgroundColor = '#2A2A2A';
                    e.currentTarget.style.borderColor = '#3a3a3a';
                  }}
                >
                  <FontAwesomeIcon icon={faWandMagicSparkles} style={{ color: '#AC8E66', fontSize: '16px' }} />
                  <span>Text verbessern</span>
                </button>

                {/* Text fortsetzen */}
                <button
                  onClick={() => handleTextAI('continue')}
                  disabled={isAIProcessing}
                  style={{
                    flex: '1 1 auto',
                    minWidth: '140px',
                    padding: '12px 16px',
                    backgroundColor: '#2A2A2A',
                    border: '1px solid #3a3a3a',
                    borderRadius: '8px',
                    color: '#e5e5e5',
                    fontFamily: 'monospace',
                    fontSize: '10px',
                    cursor: isAIProcessing ? 'not-allowed' : 'pointer',
                    opacity: isAIProcessing ? 0.5 : 1,
                    transition: 'all 0.2s',
                    display: 'flex',
                    flexDirection: 'column',
                    alignItems: 'center',
                    gap: '6px',
                  }}
                  onMouseEnter={(e) => {
                    if (!isAIProcessing) {
                      e.currentTarget.style.backgroundColor = '#3a3a3a';
                      e.currentTarget.style.borderColor = '#AC8E66';
                    }
                  }}
                  onMouseLeave={(e) => {
                    e.currentTarget.style.backgroundColor = '#2A2A2A';
                    e.currentTarget.style.borderColor = '#3a3a3a';
                  }}
                >
                  <FontAwesomeIcon icon={faArrowRight} style={{ color: '#AC8E66', fontSize: '16px' }} />
                  <span>Text fortsetzen</span>
                </button>

                {/* Zusammenfassen */}
                <button
                  onClick={() => handleTextAI('summarize')}
                  disabled={isAIProcessing}
                  style={{
                    flex: '1 1 auto',
                    minWidth: '140px',
                    padding: '12px 16px',
                    backgroundColor: '#2A2A2A',
                    border: '1px solid #3a3a3a',
                    borderRadius: '8px',
                    color: '#e5e5e5',
                    fontFamily: 'monospace',
                    fontSize: '10px',
                    cursor: isAIProcessing ? 'not-allowed' : 'pointer',
                    opacity: isAIProcessing ? 0.5 : 1,
                    transition: 'all 0.2s',
                    display: 'flex',
                    flexDirection: 'column',
                    alignItems: 'center',
                    gap: '6px',
                  }}
                  onMouseEnter={(e) => {
                    if (!isAIProcessing) {
                      e.currentTarget.style.backgroundColor = '#3a3a3a';
                      e.currentTarget.style.borderColor = '#AC8E66';
                    }
                  }}
                  onMouseLeave={(e) => {
                    e.currentTarget.style.backgroundColor = '#2A2A2A';
                    e.currentTarget.style.borderColor = '#3a3a3a';
                  }}
                >
                  <FontAwesomeIcon icon={faCompress} style={{ color: '#AC8E66', fontSize: '16px' }} />
                  <span>Zusammenfassen</span>
                </button>

                {/* Markdown-Format */}
                <button
                  onClick={() => handleTextAI('markdown')}
                  disabled={isAIProcessing}
                  style={{
                    flex: '1 1 auto',
                    minWidth: '140px',
                    padding: '12px 16px',
                    backgroundColor: '#2A2A2A',
                    border: '1px solid #3a3a3a',
                    borderRadius: '8px',
                    color: '#e5e5e5',
                    fontFamily: 'monospace',
                    fontSize: '10px',
                    cursor: isAIProcessing ? 'not-allowed' : 'pointer',
                    opacity: isAIProcessing ? 0.5 : 1,
                    transition: 'all 0.2s',
                    display: 'flex',
                    flexDirection: 'column',
                    alignItems: 'center',
                    gap: '6px',
                  }}
                  onMouseEnter={(e) => {
                    if (!isAIProcessing) {
                      e.currentTarget.style.backgroundColor = '#3a3a3a';
                      e.currentTarget.style.borderColor = '#AC8E66';
                    }
                  }}
                  onMouseLeave={(e) => {
                    e.currentTarget.style.backgroundColor = '#2A2A2A';
                    e.currentTarget.style.borderColor = '#3a3a3a';
                  }}
                >
                  <FontAwesomeIcon icon={faCode} style={{ color: '#AC8E66', fontSize: '16px' }} />
                  <span>Markdown-Format</span>
                </button>
              </div>

              {/* AI Processing Indicator */}
              {isAIProcessing && (
                <div
                  style={{
                    marginTop: '12px',
                    padding: '12px',
                    backgroundColor: '#2A2A2A',
                    borderRadius: '8px',
                    display: 'flex',
                    alignItems: 'center',
                    justifyContent: 'center',
                    gap: '12px',
                  }}
                >
                  <div
                    style={{
                      width: '20px',
                      height: '20px',
                      border: '2px solid #AC8E66',
                      borderTopColor: 'transparent',
                      borderRadius: '50%',
                      animation: 'spin 1s linear infinite',
                    }}
                  />
                  <span style={{ fontFamily: 'monospace', fontSize: '12px', color: '#AC8E66' }}>
                    AI verarbeitet...
                  </span>
                </div>
              )}

              {/* AI Error */}
              {aiError && (
                <div
                  style={{
                    marginTop: '12px',
                    padding: '12px',
                    backgroundColor: 'rgba(239, 68, 68, 0.1)',
                    border: '1px solid #ef4444',
                    borderRadius: '8px',
                    color: '#ef4444',
                    fontFamily: 'monospace',
                    fontSize: '11px',
                    textAlign: 'center',
                  }}
                >
                  {aiError}
                </div>
              )}

              <style>{`
                @keyframes spin {
                  from { transform: rotate(0deg); }
                  to { transform: rotate(360deg); }
                }
              `}</style>
            </div>
          )}

          {/* Content Display */}
          <div style={{ padding: '0 1.5rem 1rem 1.5rem' }}>
            <ZenMarkdownPreview
              content={currentContent}
              height="500px"
              onContentChange={handleContentUpdate}
            />
          </div>
        </div>

        {/* Character Count */}
        <div className="mb-12">
          <p className="text-[#777] font-mono text-[10px] mt-2">
            {currentContent.length} Zeichen • {currentContent.split('\n').length} Zeilen
          </p>
        </div>

        {/* Post Result Status */}
        {postResult && (
          <div
            className={`w-full max-w-2xl mb-6 p-4 rounded-lg border ${
              postResult.success
                ? 'bg-green-900/20 border-green-600'
                : 'bg-red-900/20 border-red-600'
            }`}
              style={{ padding: '0.5rem 1.5rem' }}

          >
            <div className="flex items-center gap-3">
              <FontAwesomeIcon
                icon={postResult.success ? faCheck : faRotateLeft}
                className={postResult.success ? 'text-green-500' : 'text-red-500'}
              />
              <div className="flex-1 flex items-center gap-2">
                <p
                  className={`font-mono text-sm ${
                    postResult.success ? 'text-green-400' : 'text-red-400'
                  }`}
                >
                  {postResult.success
                    ? `Erfolgreich auf ${platformLabels[platform]} gepostet!`
                    : `Fehler beim Posten: ${postResult.error}`}
                </p>
                {!postResult.success && (
                  <button
                    onClick={onOpenSettings}
                    className="text-[#777] hover:text-[#AC8E66] transition-colors"
                    title="Social Media API konfigurieren"
                  >
                    <FontAwesomeIcon icon={faCog} className="text-lg" />
                  </button>
                )}
                {postResult.success && postResult.url && (
                  <a
                    href={postResult.url}
                    target="_blank"
                    rel="noopener noreferrer"
                    className="text-xs text-blue-400 hover:underline ml-2"
                  >
                    Post öffnen →
                  </a>
                )}
              </div>
            </div>
          </div>
        )}

        {!useHeaderActions && (
          <div
            className="flex flex-wrap gap-4 mb-8 justify-center"
            style={{ padding: "0.5rem 1.5rem" }}
          >
            <ZenRoughButton
              label={copied ? "✓ Kopiert!" : "Kopieren"}
              icon={<FontAwesomeIcon icon={copied ? faCheck : faCopy} className="text-[#AC8E66]" />}
              onClick={handleCopy}
              variant={copied ? "active" : "default"}
            />

            <ZenRoughButton
              label="Download"
              icon={<FontAwesomeIcon icon={faDownload} className="text-[#AC8E66]" />}
              onClick={handleDownload}
            />

            <ZenRoughButton
              label="Nachbearbeiten"
              icon="✏️"
              onClick={onBack}
              variant="default"
            />

            {cameFromDocStudio && onBackToDocStudio && (
              <ZenRoughButton
                label="Zurück zu Doc Studio"
                icon={<FontAwesomeIcon icon={faArrowLeft} className="text-[#AC8E66]" />}
                onClick={() => onBackToDocStudio(currentContent)}
                variant="default"
              />
            )}

            {cameFromDashboard && onBackToDashboard && (
              <ZenRoughButton
                label="Zum Dashboard"
                icon={<FontAwesomeIcon icon={faTableList} className="text-[#AC8E66]" />}
                onClick={() => onBackToDashboard(currentContent)}
                variant="default"
              />
            )}

            {socialPlatform && (
              <ZenRoughButton
                label="Direkt posten"
                icon={<FontAwesomeIcon icon={faRocket} className="text-[#AC8E66]" />}
                onClick={handlePost}
                disabled={isPosting}
              />
            )}

            <ZenRoughButton
              label="Neuer Transform"
              icon={<FontAwesomeIcon icon={faRotateLeft} className="text-[#AC8E66]" />}
              onClick={onReset}
            />

            <ZenRoughButton
              label="Planen"
              icon={<FontAwesomeIcon icon={faCalendarDays} className="text-[#AC8E66]" />}
              onClick={() => setShowPlannerModal(true)}
              variant="default"
            />

            <ZenRoughButton
              label="Posten"
              icon={<FontAwesomeIcon icon={faPaperPlane} className="text-[#AC8E66]" />}
              onClick={() => setShowPostenModal(true)}
              variant="default"
              disabled={isMultiPosting}
            />
          </div>
        )}

        {/* Multi-Post Results */}
        {multiPostResults.length > 0 && (
          <div className="w-full max-w-2xl mb-6 p-4 rounded-lg border border-[#AC8E66] bg-[#2A2A2A]">
            <h4 className="font-mono text-sm text-[#AC8E66] mb-3">Posting-Ergebnisse:</h4>
            {multiPostResults.map((result, index) => (
              <div key={index} className={`flex items-center gap-2 mb-2 ${result.success ? 'text-green-400' : 'text-red-400'}`}>
                <FontAwesomeIcon icon={result.success ? faCheck : faCog} className="text-xs" />
                <span className="font-mono text-xs">
                  {result.platform}: {result.success ? 'Erfolgreich' : result.error}
                </span>
                {result.success && result.url && (
                  <a href={result.url} target="_blank" rel="noopener noreferrer" className="text-blue-400 text-xs hover:underline ml-2">
                    Öffnen →
                  </a>
                )}
              </div>
            ))}
          </div>
        )}

        {/* Info Text */}
        <div className="text-center max-w-2xl space-y-2">
          <p className="text-[#777] font-mono text-[12px] text-[#AC8E66] leading-relaxed">
            {socialPlatform && hasConfig
              ? `Du kannst den Content direkt auf ${platformMapping[platform]} posten oder manuell kopieren.`
              : `Kopiere den Content und füge ihn in ${platformLabels[platform]} ein.`}
          </p>
          {socialPlatform && !hasConfig && (
            <p className="text-[#555] font-mono text-[10px] italic">
              <FontAwesomeIcon icon={faLightbulb} style={{ color: '#AC8E66', marginRight: '4px' }} />
              Optional: API-Credentials konfigurieren für direktes Posten
            </p>
          )}
        </div>
      </div>

      {/* Planner Modal */}
      <ZenPlannerModal
        isOpen={showPlannerModal}
        onClose={() => setShowPlannerModal(false)}
        scheduledPosts={scheduledPosts}
        posts={socialPlatform ? [{
          platform: socialPlatform as any,
          title: currentContent.split('\n')[0]?.replace(/^#\s*/, '') || 'Untitled',
          content: currentContent,
          characterCount: currentContent.length,
          wordCount: currentContent.split(/\s+/).filter(Boolean).length,
        }] : []}
        onScheduleSave={(posts) => {
          setScheduledPosts(posts);
          setShowPlannerModal(false);
        }}
        defaultTab="planen"
      />

      {/* Posten Platform Selection Modal */}
      <ZenPostenModal
        isOpen={showPostenModal}
        onClose={() => setShowPostenModal(false)}
        onSelectPlatforms={handlePlatformSelection}
        currentPlatform={socialPlatform}
      />

      {/* Posten Method Choice Modal */}
      <ZenPostMethodModal
        isOpen={showPostMethodModal}
        onClose={() => setShowPostMethodModal(false)}
        onDirectPost={handleMultiDirectPost}
        onAIOptimize={handleMultiAIOptimize}
        selectedPlatforms={selectedPostPlatforms}
      />
    </div>
  );
};
